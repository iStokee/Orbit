<ResourceDictionary
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:Orbit.Converters"
    xmlns:dragablz="http://dragablz.net/winfx/xaml/dragablz"
    xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
    xmlns:models="clr-namespace:Orbit.Models"
    xmlns:selectors="clr-namespace:Orbit.Selectors">

    <!--  Converters needed for session templates  -->
    <converters:SessionStateToColorConverter x:Key="SessionStateToColorConverter" />
    <converters:InjectionStateToColorConverter x:Key="InjectionStateToColorConverter" />
    <converters:OrbitViewTabHeaderSizeToHeightConverter x:Key="TabHeaderSizeConverter" />

    <!--  Session Content Template - Shows the embedded RS window  -->
    <DataTemplate x:Key="SessionContentTemplate">
        <ContentControl
            HorizontalAlignment="Stretch"
            VerticalAlignment="Stretch"
            Content="{Binding HostControl}" />
    </DataTemplate>

    <!--  Compact header used by Orbit Grid layout tabs  -->
    <DataTemplate x:Key="OrbitSessionHeaderTemplate" xmlns:local="clr-namespace:Orbit">
        <StackPanel
            Margin="8,4"
            Orientation="Horizontal"
            MinHeight="{Binding Source={x:Static local:Settings.Default}, Path=OrbitViewTabHeaderSize, Converter={StaticResource TabHeaderSizeConverter}}">
            <Ellipse
                Width="10"
                Height="10"
                Margin="0,0,8,0"
                VerticalAlignment="Center"
                Fill="{Binding State, Converter={StaticResource SessionStateToColorConverter}}"
                Stroke="{Binding InjectionState, Converter={StaticResource InjectionStateToColorConverter}}"
                StrokeThickness="2"
                ToolTip="{Binding StatusSummary}" />

            <TextBlock
                VerticalAlignment="Center"
                FontSize="12"
                FontWeight="SemiBold"
                Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                Text="{Binding Name}" />
        </StackPanel>
    </DataTemplate>

    <!--  Session Header Item Template (Unified across MainWindow and Orbit View)  -->
    <DataTemplate x:Key="SessionHeaderItemTemplate">
        <Border
            Margin="4,4,4,0"
            Padding="12,8,12,10"
            CornerRadius="8,8,0,0">
            <Border.Style>
                <Style TargetType="Border">
                    <!--  Default inactive tab state  -->
                    <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.ThemeBackground}" />
                    <Setter Property="Opacity" Value="0.5" />
                    <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Gray7}" />
                    <Setter Property="BorderThickness" Value="1,1,1,0" />
                    <Setter Property="Effect">
                        <Setter.Value>
                            <DropShadowEffect
                                BlurRadius="3"
                                Direction="270"
                                Opacity="0.1"
                                ShadowDepth="1"
                                Color="{Binding Source={StaticResource MahApps.Colors.ThemeForeground}, FallbackValue=Black}" />
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <!--  Hover state for inactive tabs with smooth transition  -->
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=dragablz:DragablzItem}}" Value="False" />
                                <Condition Binding="{Binding IsMouseOver, RelativeSource={RelativeSource Self}}" Value="True" />
                            </MultiDataTrigger.Conditions>
                            <MultiDataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation
                                            Storyboard.TargetProperty="Opacity"
                                            To="0.8"
                                            Duration="0:0:0.2">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut" />
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </MultiDataTrigger.EnterActions>
                            <MultiDataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation
                                            Storyboard.TargetProperty="Opacity"
                                            To="0.5"
                                            Duration="0:0:0.2">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut" />
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </MultiDataTrigger.ExitActions>
                            <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Accent2}" />
                            <Setter Property="BorderThickness" Value="1.5,1.5,1.5,0" />
                            <Setter Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect
                                        BlurRadius="6"
                                        Direction="270"
                                        Opacity="0.2"
                                        ShadowDepth="1.5"
                                        Color="{Binding Source={StaticResource MahApps.Colors.Accent}, FallbackValue=#007ACC}" />
                                </Setter.Value>
                            </Setter>
                        </MultiDataTrigger>
                        <!--  Selected state with smooth transition  -->
                        <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=dragablz:DragablzItem}}" Value="True">
                            <DataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation
                                            Storyboard.TargetProperty="Opacity"
                                            To="1.0"
                                            Duration="0:0:0.25">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut" />
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.EnterActions>
                            <DataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation
                                            Storyboard.TargetProperty="Opacity"
                                            To="0.5"
                                            Duration="0:0:0.2">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseIn" />
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.ExitActions>
                            <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.Accent}" />
                            <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Accent}" />
                            <Setter Property="BorderThickness" Value="2,2,2,0" />
                            <Setter Property="Padding" Value="12,8,12,10" />
                            <Setter Property="Effect">
                                <Setter.Value>
                                    <DropShadowEffect
                                        BlurRadius="10"
                                        Direction="270"
                                        Opacity="0.35"
                                        ShadowDepth="3"
                                        Color="{Binding Source={StaticResource MahApps.Colors.Accent}, FallbackValue=#007ACC}" />
                                </Setter.Value>
                            </Setter>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <Grid>
                <!--  Accent underline for selected tab with smooth fade-in  -->
                <Rectangle
                    Height="3"
                    Margin="0,0,0,0"
                    VerticalAlignment="Bottom"
                    Fill="{DynamicResource MahApps.Brushes.Accent2}"
                    Opacity="0"
                    RadiusX="1.5"
                    RadiusY="1.5">
                    <Rectangle.Style>
                        <Style TargetType="Rectangle">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=dragablz:DragablzItem}}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation
                                                    Storyboard.TargetProperty="Opacity"
                                                    To="1.0"
                                                    Duration="0:0:0.3">
                                                    <DoubleAnimation.EasingFunction>
                                                        <QuadraticEase EasingMode="EaseOut" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                    <DataTrigger.ExitActions>
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation
                                                    Storyboard.TargetProperty="Opacity"
                                                    To="0.0"
                                                    Duration="0:0:0.2">
                                                    <DoubleAnimation.EasingFunction>
                                                        <QuadraticEase EasingMode="EaseIn" />
                                                    </DoubleAnimation.EasingFunction>
                                                </DoubleAnimation>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.ExitActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Rectangle.Style>
                </Rectangle>

                <!--  Session header content  -->
                <StackPanel
                    x:Name="SessionHeader"
                    VerticalAlignment="Center"
                    Orientation="Horizontal">

                    <!--  Icon indicator for external scripts  -->
                    <iconPacks:PackIconMaterial
                        Width="14"
                        Height="14"
                        Margin="0,0,6,0"
                        VerticalAlignment="Center"
                        Kind="CodeBraces"
                        ToolTip="External Script Window">
                        <iconPacks:PackIconMaterial.Style>
                            <Style TargetType="iconPacks:PackIconMaterial">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.Accent3}" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsExternalScript}" Value="True">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </iconPacks:PackIconMaterial.Style>
                    </iconPacks:PackIconMaterial>

                    <!--  Status indicator for RS3 sessions (hidden for scripts)  -->
                    <Ellipse
                        Width="10"
                        Height="10"
                        Margin="0,0,8,0"
                        VerticalAlignment="Center"
                        Fill="{Binding State, Converter={StaticResource SessionStateToColorConverter}}"
                        Stroke="{Binding InjectionState, Converter={StaticResource InjectionStateToColorConverter}}"
                        StrokeThickness="2"
                        ToolTip="{Binding StatusSummary}">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Visibility" Value="Visible" />
                                <Style.Triggers>
                                    <!--  Hide for external scripts  -->
                                    <DataTrigger Binding="{Binding IsExternalScript}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                    </DataTrigger>
                                    <!--  Pulse animation on injecting state  -->
                                    <DataTrigger Binding="{Binding State}" Value="{x:Static models:SessionState.Injecting}">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard>
                                                <Storyboard RepeatBehavior="Forever">
                                                    <DoubleAnimation
                                                        AutoReverse="True"
                                                        Storyboard.TargetProperty="Opacity"
                                                        From="1.0"
                                                        To="0.3"
                                                        Duration="0:0:0.8" />
                                                </Storyboard>
                                            </BeginStoryboard>
                                        </DataTrigger.EnterActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <Grid Margin="0,0,4,0" VerticalAlignment="Center">
                        <TextBlock
                            VerticalAlignment="Center"
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                            Text="{Binding Name}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Opacity" Value="0.7" />
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRenaming}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                        <!--  Brighter text on selected tab with smooth transition  -->
                                        <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=dragablz:DragablzItem}}" Value="True">
                                            <DataTrigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation
                                                            Storyboard.TargetProperty="Opacity"
                                                            To="1.0"
                                                            Duration="0:0:0.2">
                                                            <DoubleAnimation.EasingFunction>
                                                                <QuadraticEase EasingMode="EaseOut" />
                                                            </DoubleAnimation.EasingFunction>
                                                        </DoubleAnimation>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.EnterActions>
                                            <DataTrigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation
                                                            Storyboard.TargetProperty="Opacity"
                                                            To="0.7"
                                                            Duration="0:0:0.15">
                                                            <DoubleAnimation.EasingFunction>
                                                                <QuadraticEase EasingMode="EaseIn" />
                                                            </DoubleAnimation.EasingFunction>
                                                        </DoubleAnimation>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </DataTrigger.ExitActions>
                                            <Setter Property="FontWeight" Value="Bold" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <TextBox
                            MinWidth="110"
                            Margin="0"
                            Padding="2,0"
                            VerticalContentAlignment="Center"
                            Background="{DynamicResource MahApps.Brushes.Gray7}"
                            BorderBrush="{DynamicResource MahApps.Brushes.Accent}"
                            BorderThickness="0,0,0,1"
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                            Text="{Binding EditableName, UpdateSourceTrigger=PropertyChanged}"
                            Visibility="Collapsed">
                            <TextBox.Style>
                                <Style TargetType="TextBox">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsRenaming}" Value="True">
                                            <Setter Property="Visibility" Value="Visible" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBox.Style>
                        </TextBox>
                    </Grid>

                    <Button
                        Width="26"
                        Height="26"
                        Margin="6,0,0,0"
                        Padding="4"
                        Command="{Binding DataContext.BeginSessionRenameCommand, RelativeSource={RelativeSource AncestorType=dragablz:TabablzControl}}"
                        CommandParameter="{Binding}">
                        <Button.Style>
                            <Style BasedOn="{StaticResource MahApps.Styles.Button.Circle}" TargetType="Button">
                                <Setter Property="ToolTip" Value="Rename session" />
                                <Setter Property="Visibility" Value="Visible" />
                                <Setter Property="Opacity" Value="0.75" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsRenaming}" Value="True">
                                        <Setter Property="Visibility" Value="Collapsed" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=dragablz:DragablzItem}}" Value="True">
                                        <Setter Property="Opacity" Value="1" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                        <iconPacks:PackIconMaterial
                            Width="14"
                            Height="14"
                            Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                            Kind="Pencil" />
                    </Button>

                    <StackPanel
                        Margin="4,0,0,0"
                        VerticalAlignment="Center"
                        Orientation="Horizontal">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsRenaming}" Value="True">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>

                        <Button
                            Width="26"
                            Height="26"
                            Margin="0,0,4,0"
                            Padding="4"
                            Command="{Binding DataContext.CommitSessionRenameCommand, RelativeSource={RelativeSource AncestorType=dragablz:TabablzControl}}"
                            CommandParameter="{Binding}">
                            <Button.Style>
                                <Style BasedOn="{StaticResource MahApps.Styles.Button.Circle}" TargetType="Button">
                                    <Setter Property="ToolTip" Value="Save name" />
                                </Style>
                            </Button.Style>
                            <iconPacks:PackIconMaterial
                                Width="14"
                                Height="14"
                                Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                                Kind="Check" />
                        </Button>

                        <Button
                            Width="26"
                            Height="26"
                            Padding="4"
                            Command="{Binding DataContext.CancelSessionRenameCommand, RelativeSource={RelativeSource AncestorType=dragablz:TabablzControl}}"
                            CommandParameter="{Binding}">
                            <Button.Style>
                                <Style BasedOn="{StaticResource MahApps.Styles.Button.Circle}" TargetType="Button">
                                    <Setter Property="ToolTip" Value="Cancel rename" />
                                </Style>
                            </Button.Style>
                            <iconPacks:PackIconMaterial
                                Width="14"
                                Height="14"
                                Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                                Kind="Close" />
                        </Button>
                    </StackPanel>
                </StackPanel>
            </Grid>
        </Border>
    </DataTemplate>

    <!--  Tool Header Template (for non-session tabs)  -->
    <DataTemplate x:Key="ToolHeaderItemTemplate">
        <StackPanel
            x:Name="ToolHeader"
            VerticalAlignment="Center"
            Orientation="Horizontal">
            <iconPacks:PackIconMaterial
                Width="14"
                Height="14"
                Margin="0,0,8,0"
                VerticalAlignment="Center"
                Kind="{Binding Icon}">
                <iconPacks:PackIconMaterial.Style>
                    <Style TargetType="iconPacks:PackIconMaterial">
                        <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.Accent2}" />
                        <Setter Property="Opacity" Value="0.8" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=dragablz:DragablzItem}}" Value="True">
                                <Setter Property="Foreground" Value="{DynamicResource MahApps.Brushes.IdealForeground}" />
                                <Setter Property="Opacity" Value="1" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </iconPacks:PackIconMaterial.Style>
            </iconPacks:PackIconMaterial>
            <TextBlock
                VerticalAlignment="Center"
                FontWeight="SemiBold"
                Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                Text="{Binding Name}">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Opacity" Value="0.7" />
                        <Style.Triggers>
                            <!--  Brighter text on selected tab with smooth transition  -->
                            <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=dragablz:DragablzItem}}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation
                                                Storyboard.TargetProperty="Opacity"
                                                To="1.0"
                                                Duration="0:0:0.2">
                                                <DoubleAnimation.EasingFunction>
                                                    <QuadraticEase EasingMode="EaseOut" />
                                                </DoubleAnimation.EasingFunction>
                                            </DoubleAnimation>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.EnterActions>
                                <DataTrigger.ExitActions>
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation
                                                Storyboard.TargetProperty="Opacity"
                                                To="0.7"
                                                Duration="0:0:0.15">
                                                <DoubleAnimation.EasingFunction>
                                                    <QuadraticEase EasingMode="EaseIn" />
                                                </DoubleAnimation.EasingFunction>
                                            </DoubleAnimation>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </DataTrigger.ExitActions>
                                <Setter Property="FontWeight" Value="Bold" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>
        </StackPanel>
    </DataTemplate>

    <!--  HeaderItemTemplateSelector - Chooses between Session and Tool headers  -->
    <selectors:HeaderItemTemplateSelector
        x:Key="TabHeaderTemplateSelector"
        SessionHeaderTemplate="{StaticResource SessionHeaderItemTemplate}"
        ToolHeaderTemplate="{StaticResource ToolHeaderItemTemplate}" />

</ResourceDictionary>
