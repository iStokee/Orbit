<UserControl
    x:Class="Orbit.Views.SessionGalleryView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:Controls="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
    xmlns:converters="clr-namespace:Orbit.Converters"
    xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
    xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
    Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}">

    <UserControl.Resources>
        <converters:SessionStateToColorConverter x:Key="SessionStateToColorConverter" />
        <converters:InjectionStateToColorConverter x:Key="InjectionStateToColorConverter" />
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:InverseBooleanConverter x:Key="InverseBoolConverter" />

        <!--  Thumbnail card style  -->
        <Style x:Key="ThumbnailCard" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource MahApps.Brushes.ThemeBackground}" />
            <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Gray5}" />
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="8" />
            <Setter Property="Cursor" Value="Hand" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Accent}" />
                    <Setter Property="BorderThickness" Value="3" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Header  -->
        <Border Grid.Row="0" Style="{StaticResource Orbit.ToolHeader}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>
                <Border Style="{StaticResource Orbit.ToolHeaderIcon}">
                    <iconPacks:PackIconMaterial
                        Width="35"
                        Height="35"
                        Margin="10,10,0,0"
                        Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                        Kind="ViewModule" />
                </Border>
                <StackPanel
                    Grid.Column="1"
                    Margin="12,0,0,0"
                    VerticalAlignment="Center">
                    <TextBlock
                        FontSize="22"
                        FontWeight="Bold"
                        Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                        Text="Gallery View" />
                    <StackPanel Margin="0,4,0,0" Orientation="Horizontal">
                        <TextBlock
                            FontSize="12"
                            Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                            Opacity="0.85"
                            Text="{Binding Sessions.Count, StringFormat='{}{0} Sessions'}" />
                    </StackPanel>
                </StackPanel>
                <Button
                    Grid.Column="2"
                    Width="40"
                    Height="40"
                    Margin="0,0,8,0"
                    Command="{Binding RefreshThumbnailsCommand}"
                    Style="{StaticResource MahApps.Styles.Button.Circle}"
                    ToolTip="Refresh All Thumbnails">
                    <iconPacks:PackIconMaterial
                        Width="20"
                        Height="20"
                        Kind="Refresh" />
                </Button>
            </Grid>
        </Border>

        <!--  Toolbar  -->
        <Border
            Grid.Row="1"
            Margin="0,12,0,0"
            Padding="12"
            Background="{DynamicResource MahApps.Brushes.Gray9}"
            BorderBrush="{DynamicResource MahApps.Brushes.Gray7}"
            BorderThickness="1"
            CornerRadius="6">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1*" />
                    <ColumnDefinition Width="1.5*" />
                    <ColumnDefinition Width=".5*" />
                </Grid.ColumnDefinitions>

                <StackPanel
                    Grid.Row="0"
                    Grid.Column="0"
                    Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,12,0"
                        VerticalAlignment="Center"
                        Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                        Text="Thumbnail Size:" />
                    <Slider
                        Width="150"
                        VerticalAlignment="Center"
                        IsEnabled="{Binding UseCustomThumbnailSize, Converter={StaticResource InverseBoolConverter}}"
                        IsSnapToTickEnabled="True"
                        Maximum="800"
                        Minimum="200"
                        TickFrequency="50"
                        Value="{Binding ThumbnailSize}" />
                    <TextBlock
                        Width="60"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center"
                        Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                        Text="{Binding EffectiveThumbnailSize, StringFormat='{}{0}px'}" />
                </StackPanel>

                <!--  Custom Size Override  -->
                <StackPanel
                    Grid.Row="0"
                    Grid.Column="1"
                    Margin="16,0,0,0"
                    Orientation="Horizontal">
                    <CheckBox
                        VerticalAlignment="Center"
                        Content="Custom Size:"
                        Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                        IsChecked="{Binding UseCustomThumbnailSize}" />
                    <mah:NumericUpDown
                        Width="100"
                        Margin="8,0,0,0"
                        VerticalAlignment="Center"
                        IsEnabled="{Binding UseCustomThumbnailSize}"
                        Maximum="800"
                        Minimum="200"
                        StringFormat="F0"
                        Value="{Binding CustomThumbnailSize}" />
                </StackPanel>

                <StackPanel
                    Grid.Row="0"
                    Grid.Column="2"
                    Orientation="Vertical">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,8,0"
                            VerticalAlignment="Center"
                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                            Text="Auto-refresh (All):" />
                        <Controls:ToggleSwitch
                            IsOn="{Binding AutoRefreshEnabled}"
                            OffContent="Off"
                            OnContent="On"
                            ToolTip="Automatically refresh thumbnails using the global rate." />
                    </StackPanel>
                    <StackPanel Margin="0,8,0,0" Orientation="Horizontal">
                        <TextBlock
                            Margin="0,0,8,0"
                            VerticalAlignment="Center"
                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                            Text="Overrides:" />
                        <Controls:ToggleSwitch
                            IsOn="{Binding AllowSessionOverrides}"
                            OffContent="Disabled"
                            OnContent="Enabled"
                            ToolTip="Allow sessions to override the global refresh settings." />
                    </StackPanel>
                </StackPanel>

                <StackPanel
                    Grid.Row="1"
                    Grid.Column="0"
                    Grid.ColumnSpan="3"
                    Margin="0,12,0,0"
                    Orientation="Horizontal">
                    <TextBlock
                        Margin="0,0,12,0"
                        VerticalAlignment="Center"
                        Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                        Text="All Sessions Rate:" />
                    <Slider
                        Width="220"
                        VerticalAlignment="Center"
                        IsSnapToTickEnabled="True"
                        Maximum="{Binding MaximumRefreshInterval}"
                        Minimum="{Binding MinimumRefreshInterval}"
                        TickFrequency="1"
                        ToolTip="Adjust the shared refresh cadence for sessions following the global policy."
                        Value="{Binding GlobalRefreshIntervalSeconds, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                    <TextBlock
                        Margin="12,0,0,0"
                        VerticalAlignment="Center"
                        Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                        Text="{Binding GlobalRefreshIntervalSeconds, StringFormat='{}{0:0}s'}" />
                </StackPanel>
            </Grid>
        </Border>

        <!--  Gallery Grid  -->
        <Border Grid.Row="2" Style="{StaticResource Orbit.ToolCard}">
            <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
                <ItemsControl Margin="8" ItemsSource="{Binding Sessions}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Width="{Binding DataContext.EffectiveThumbnailSize, RelativeSource={RelativeSource AncestorType=ItemsControl}}" Margin="0,0,0,16">
                                <Border Width="{Binding DataContext.EffectiveThumbnailSize, RelativeSource={RelativeSource AncestorType=ItemsControl}}" Height="{Binding DataContext.ThumbnailSizeWithAspect, RelativeSource={RelativeSource AncestorType=ItemsControl}}">
                                    <Border.InputBindings>
                                        <MouseBinding
                                            Command="{Binding DataContext.ActivateSessionCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                            CommandParameter="{Binding}"
                                            MouseAction="LeftClick" />
                                    </Border.InputBindings>

                                    <!--  Hover effect animation  -->
                                    <Border.Style>
                                        <Style BasedOn="{StaticResource ThumbnailCard}" TargetType="Border">
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Trigger.EnterActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation
                                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                                                    To="1.05"
                                                                    Duration="0:0:0.15" />
                                                                <DoubleAnimation
                                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                                                    To="1.05"
                                                                    Duration="0:0:0.15" />
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.EnterActions>
                                                    <Trigger.ExitActions>
                                                        <BeginStoryboard>
                                                            <Storyboard>
                                                                <DoubleAnimation
                                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                                                    To="1.0"
                                                                    Duration="0:0:0.15" />
                                                                <DoubleAnimation
                                                                    Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                                                    To="1.0"
                                                                    Duration="0:0:0.15" />
                                                            </Storyboard>
                                                        </BeginStoryboard>
                                                    </Trigger.ExitActions>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <Border.RenderTransform>
                                        <ScaleTransform CenterX="0.5" CenterY="0.5" ScaleX="1.0" ScaleY="1.0" />
                                    </Border.RenderTransform>
                                    <Border.RenderTransformOrigin>0.5,0.5</Border.RenderTransformOrigin>

                                    <Grid>
                                        <!--  Thumbnail Image  -->
                                        <Image
                                            Source="{Binding Thumbnail}"
                                            Stretch="Uniform"
                                            Visibility="{Binding HasThumbnail, Converter={StaticResource BoolToVisibilityConverter}}" />

                                        <!--  Placeholder when no thumbnail  -->
                                        <Grid Visibility="{Binding HasThumbnail, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverted}">
                                            <iconPacks:PackIconMaterial
                                                Width="64"
                                                Height="64"
                                                HorizontalAlignment="Center"
                                                VerticalAlignment="Center"
                                                Foreground="{DynamicResource MahApps.Brushes.Gray5}"
                                                Kind="ImageOff" />
                                        </Grid>

                                        <!--  Overlay with session info  -->
                                        <Border VerticalAlignment="Bottom" Background="#AA000000">
                                            <Grid Margin="8">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="Auto" />
                                                </Grid.RowDefinitions>

                                                <TextBlock
                                                    Grid.Row="0"
                                                    FontSize="14"
                                                    FontWeight="SemiBold"
                                                    Foreground="White"
                                                    Text="{Binding Name}"
                                                    TextTrimming="CharacterEllipsis" />

                                                <StackPanel
                                                    Grid.Row="1"
                                                    Margin="0,4,0,0"
                                                    Orientation="Horizontal">
                                                    <!--  Status indicator  -->
                                                    <Ellipse
                                                        Width="10"
                                                        Height="10"
                                                        Margin="0,0,6,0"
                                                        Fill="{Binding State, Converter={StaticResource SessionStateToColorConverter}}"
                                                        Stroke="{Binding InjectionState, Converter={StaticResource InjectionStateToColorConverter}}"
                                                        StrokeThickness="2" />

                                                    <TextBlock
                                                        FontSize="10"
                                                        Foreground="White"
                                                        Opacity="0.8"
                                                        Text="{Binding State}" />
                                                </StackPanel>
                                            </Grid>
                                        </Border>

                                        <!--  External script indicator  -->
                                        <Border
                                            Padding="6,3"
                                            HorizontalAlignment="Right"
                                            VerticalAlignment="Top"
                                            Background="{DynamicResource MahApps.Brushes.Accent}"
                                            CornerRadius="0,8,0,8"
                                            Visibility="{Binding IsExternalScript, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <iconPacks:PackIconMaterial
                                                Width="16"
                                                Height="16"
                                                Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                                                Kind="ApplicationCog" />
                                        </Border>
                                    </Grid>
                                </Border>

                                <StackPanel Margin="4,8,4,0">
                                    <StackPanel.IsEnabled>
                                        <Binding Path="DataContext.AllowSessionOverrides" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                                    </StackPanel.IsEnabled>

                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                                            Text="Override global:" />
                                        <Controls:ToggleSwitch
                                            Margin="8,0,0,0"
                                            IsOn="{Binding GalleryOverrideEnabled}"
                                            OffContent="No"
                                            OnContent="Yes"
                                            ToolTip="Toggle a per-session refresh policy." />
                                    </StackPanel>

                                    <StackPanel
                                        Margin="0,6,0,0"
                                        IsEnabled="{Binding GalleryOverrideEnabled}"
                                        Orientation="Horizontal">
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                                            Text="Auto refresh:" />
                                        <Controls:ToggleSwitch
                                            Margin="8,0,0,0"
                                            IsOn="{Binding GalleryAutoRefreshEnabled}"
                                            OffContent="Manual"
                                            OnContent="Auto"
                                            ToolTip="When off, this session keeps the last captured thumbnail until you refresh manually." />
                                    </StackPanel>

                                    <StackPanel
                                        Margin="0,6,0,0"
                                        IsEnabled="{Binding GalleryIntervalIsEnabled}"
                                        Orientation="Horizontal">
                                        <TextBlock
                                            VerticalAlignment="Center"
                                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                                            Text="Custom rate:" />
                                        <Slider
                                            Width="140"
                                            Margin="8,0,0,0"
                                            IsSnapToTickEnabled="True"
                                            Maximum="{Binding DataContext.MaximumRefreshInterval, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            Minimum="{Binding DataContext.MinimumRefreshInterval, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            TickFrequency="1"
                                            ToolTip="Seconds between automatic captures for this session."
                                            Value="{Binding GalleryRefreshIntervalSeconds, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                                        <TextBlock
                                            Margin="8,0,0,0"
                                            VerticalAlignment="Center"
                                            Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
                                            Text="{Binding GalleryRefreshIntervalSeconds, StringFormat='{}{0:0}s'}" />
                                    </StackPanel>

                                    <TextBlock
                                        Margin="0,6,0,0"
                                        FontSize="10"
                                        Foreground="{DynamicResource MahApps.Brushes.Gray5}"
                                        Text="Overrides disabled by global policy"
                                        Visibility="{Binding DataContext.AllowSessionOverrides, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverted}" />

                                    <TextBlock
                                        Margin="0,6,0,0"
                                        FontSize="10"
                                        Foreground="{DynamicResource MahApps.Brushes.Gray5}"
                                        Text="Following global refresh rate"
                                        Visibility="{Binding UsesGlobalGallerySettings, Converter={StaticResource BoolToVisibilityConverter}}" />

                                    <TextBlock
                                        Margin="0,2,0,0"
                                        FontSize="10"
                                        Foreground="{DynamicResource MahApps.Brushes.Gray5}"
                                        Text="Manual refresh only"
                                        Visibility="{Binding GalleryAutoRefreshEnabled, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverted}" />
                                </StackPanel>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>
