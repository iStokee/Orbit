<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="Orbit.Views.AccountManagerView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:Controls="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
    xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
    xmlns:converters="clr-namespace:Orbit.Converters"
    xmlns:viewModels="clr-namespace:Orbit.ViewModels"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Foreground="{DynamicResource MahApps.Brushes.ThemeForeground}"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance viewModels:AccountManagerViewModel}">

    <UserControl.Resources>
        <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter" />
    </UserControl.Resources>

    <Grid Margin="{StaticResource Orbit.ToolPageMargin}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Header  -->
        <Border Grid.Row="0" Style="{StaticResource Orbit.ToolHeader}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Border Style="{StaticResource Orbit.ToolHeaderIcon}">
                    <iconPacks:PackIconMaterial Kind="AccountMultiple" Style="{StaticResource Orbit.ToolHeaderIconGlyph}" />
                </Border>

                <StackPanel Grid.Column="1" Margin="12,0,0,0" VerticalAlignment="Center">
                    <TextBlock
                        Style="{StaticResource Orbit.ToolHeaderTitle}"
                        Text="Account Manager" />
                    <TextBlock
                        Style="{StaticResource Orbit.ToolHeaderSubtitle}"
                        Text="Organize saved accounts, control auto-login, and push credentials into live sessions." />
                </StackPanel>
            </Grid>
        </Border>

        <!--  Session Selection & Auto Login  -->
        <Border
            Grid.Row="1"
            Style="{StaticResource Orbit.ToolCard}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock
                        Text="Target Session"
                        FontSize="13"
                        FontWeight="SemiBold"
                        Foreground="{DynamicResource MahApps.Brushes.Gray2}" />
                    <ComboBox
                        Margin="0,6,0,8"
                        ItemsSource="{Binding Sessions}"
                        SelectedItem="{Binding SelectedSession}"
                        IsEnabled="{Binding HasSessions}"
                        Padding="6,2"
                        MinWidth="240"
                        Background="Transparent"
                        BorderThickness="1"
                        BorderBrush="{DynamicResource MahApps.Brushes.Gray6}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock
                                        Text="{Binding Name}"
                                        FontWeight="SemiBold" />
                                    <TextBlock
                                        Margin="8,0,0,0"
                                        Text="{Binding InjectionState}"
                                        FontSize="11"
                                        Foreground="{DynamicResource MahApps.Brushes.Gray3}" />
                                </StackPanel>
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                    <TextBlock
                        FontSize="11"
                        Foreground="{DynamicResource MahApps.Brushes.Gray4}"
                        Text="No active sessions are docked.">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasSessions}" Value="False">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                    <TextBlock
                        Margin="0,4,0,0"
                        FontSize="12"
                        Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                        Text="{Binding LoginStatusMessage}"
                        TextWrapping="Wrap" />
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <Controls:ProgressRing
                        Width="28"
                        Height="28"
                        Margin="0,0,12,0"
                        IsActive="{Binding IsLoggingIn}">
                        <Controls:ProgressRing.Style>
                            <Style TargetType="Controls:ProgressRing">
                                <Setter Property="Visibility" Value="Collapsed" />
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsLoggingIn}" Value="True">
                                        <Setter Property="Visibility" Value="Visible" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Controls:ProgressRing.Style>
                    </Controls:ProgressRing>
                    <Button
                        Command="{Binding LoginSelectedAccountCommand}"
                        Style="{StaticResource MahApps.Styles.Button.Primary}"
                        Padding="16,6"
                        MinWidth="140"
                        VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <iconPacks:PackIconMaterial
                                Kind="Login"
                                Width="16"
                                Height="16"
                                Margin="0,0,8,0" />
                            <TextBlock Text="Auto Login" FontWeight="SemiBold" />
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!--  Account List & Filter  -->
        <Border
            Grid.Row="2"
            Grid.RowSpan="2"
            Style="{StaticResource Orbit.ToolCard}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBox
                    Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                    Controls:TextBoxHelper.Watermark="Search accounts or nicknames..."
                    Controls:TextBoxHelper.ClearTextButton="True">
                    <TextBox.Style>
                        <Style TargetType="TextBox" BasedOn="{StaticResource MahApps.Styles.TextBox}">
                            <Setter Property="Controls:TextBoxHelper.UseFloatingWatermark" Value="False" />
                        </Style>
                    </TextBox.Style>
                </TextBox>

                <DataGrid
                    Grid.Row="1"
                    Margin="0,12,0,0"
                    ItemsSource="{Binding FilteredAccounts}"
                    SelectedItem="{Binding SelectedAccount}"
                    AutoGenerateColumns="False"
                    CanUserAddRows="False"
                    CanUserDeleteRows="False"
                    SelectionMode="Single"
                    GridLinesVisibility="None"
                    HeadersVisibility="Column">
                    <DataGrid.Columns>
                        <DataGridTextColumn
                            Header="Username"
                            Binding="{Binding Username}"
                            Width="*"
                            MinWidth="120"
                            IsReadOnly="True" />
                        <DataGridTextColumn
                            Header="Nickname"
                            Binding="{Binding Nickname, UpdateSourceTrigger=PropertyChanged}"
                            Width="*"
                            MinWidth="120" />
                        <DataGridTextColumn
                            Header="Password"
                            Binding="{Binding PasswordMasked}"
                            Width="120"
                            IsReadOnly="True" />
                        <DataGridTextColumn
                            Header="World"
                            Binding="{Binding PreferredWorld}"
                            Width="80"
                            IsReadOnly="True" />
                        <DataGridTextColumn
                            Header="Last Used"
                            Binding="{Binding LastUsedDisplay}"
                            Width="140"
                            IsReadOnly="True" />
                        <DataGridCheckBoxColumn
                            Header="Auto Login"
                            Binding="{Binding AutoLogin, UpdateSourceTrigger=PropertyChanged}"
                            Width="100" />
                        <DataGridTemplateColumn Header="Actions" Width="80">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button
                                        Command="{Binding DataContext.DeleteAccountCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        CommandParameter="{Binding}"
                                        Style="{StaticResource MahApps.Styles.Button.Circle}"
                                        Width="32"
                                        Height="32"
                                        ToolTip="Delete Account">
                                        <iconPacks:PackIconMaterial Kind="Delete" Width="16" Height="16" />
                                    </Button>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!--  Empty State  -->
                <Border
                    Grid.Row="1"
                    Margin="0,12,0,0"
                    Padding="48,32"
                    Background="{DynamicResource MahApps.Brushes.Gray9}"
                    BorderBrush="{DynamicResource MahApps.Brushes.Gray7}"
                    BorderThickness="1"
                    CornerRadius="8"
                    Visibility="{Binding FilteredAccounts.Count, Converter={StaticResource CountToVisibilityConverter}, ConverterParameter=Zero}">
                    <StackPanel
                        MaxWidth="360"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                        <iconPacks:PackIconMaterial
                            Width="48"
                            Height="48"
                            HorizontalAlignment="Center"
                            Foreground="{DynamicResource MahApps.Brushes.Gray4}"
                            Kind="AccountOff" />
                        <TextBlock
                            Margin="0,16,0,0"
                            HorizontalAlignment="Center"
                            FontSize="18"
                            FontWeight="SemiBold"
                            Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                            Text="No accounts yet" />
                        <TextBlock
                            Margin="0,8,0,0"
                            HorizontalAlignment="Center"
                            FontSize="13"
                            Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                            Opacity="0.75"
                            TextAlignment="Center"
                            TextWrapping="Wrap"
                            Text="Add your first RuneScape account to enable auto-login and quick session management." />
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!--  Add Account Form  -->
        <Border
            Grid.Row="4"
            Style="{StaticResource Orbit.ToolCard}"
            BorderBrush="{DynamicResource MahApps.Brushes.Accent}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="120" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <TextBox
                    Grid.Column="0"
                    Text="{Binding NewUsername, UpdateSourceTrigger=PropertyChanged}"
                    Controls:TextBoxHelper.Watermark="Username"
                    MaxLength="50"
                    Margin="0,0,8,0" />

                <TextBox
                    Grid.Column="1"
                    Text="{Binding NewNickname, UpdateSourceTrigger=PropertyChanged}"
                    Controls:TextBoxHelper.Watermark="Nickname (optional)"
                    MaxLength="50"
                    Margin="0,0,8,0" />

                <PasswordBox
                    Grid.Column="2"
                    Controls:TextBoxHelper.Watermark="Password (min 5 chars)"
                    Controls:PasswordBoxHelper.CapsLockWarningToolTip="Caps Lock is ON"
                    Margin="0,0,8,0"
                    x:Name="NewPasswordBox"
                    PasswordChanged="NewPasswordBox_PasswordChanged" />

                <Controls:NumericUpDown
                    Grid.Column="3"
                    Value="{Binding NewPreferredWorld}"
                    Minimum="1"
                    Maximum="200"
                    Margin="0,0,8,0" />

                <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <Button
                        Command="{Binding AddAccountCommand}"
                        Style="{StaticResource MahApps.Styles.Button.Circle}"
                        Width="36"
                        Height="36"
                        Margin="0,0,4,0"
                        ToolTip="Add Account">
                        <iconPacks:PackIconMaterial Kind="Plus" />
                    </Button>
                    <Button
                        Command="{Binding ClearFormCommand}"
                        Style="{StaticResource MahApps.Styles.Button.Circle}"
                        Width="36"
                        Height="36"
                        ToolTip="Clear Form">
                        <iconPacks:PackIconMaterial Kind="Close" />
                    </Button>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
