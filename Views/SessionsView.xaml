<?xml version="1.0" encoding="utf-8" ?>
<Controls:MetroWindow
    x:Class="Orbit.Views.SessionsView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:Controls="clr-namespace:MahApps.Metro.Controls;assembly=MahApps.Metro"
    xmlns:converters="clr-namespace:Orbit.Converters"
    xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
    xmlns:local="clr-namespace:Orbit"
    xmlns:viewModels="clr-namespace:Orbit.ViewModels"
    Title="Session Manager"
    Icon="/Orbital.jpg"
    Width="900"
    Height="600"
    TitleCharacterCasing="Normal"
    WindowStartupLocation="CenterOwner">

    <Controls:MetroWindow.IconTemplate>
        <DataTemplate>
            <iconPacks:PackIconMaterial
                Width="24"
                Height="24"
                Kind="ViewList" />
        </DataTemplate>
    </Controls:MetroWindow.IconTemplate>

    <Window.Resources>
        <converters:SessionStateToColorConverter x:Key="SessionStateToColorConverter" />
        <converters:InjectionStateToColorConverter x:Key="InjectionStateToColorConverter" />
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter" />
    </Window.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Header  -->
        <Border
            Grid.Row="0"
            Margin="0,0,0,15"
            Padding="15,10"
            Background="{DynamicResource MahApps.Brushes.Accent}"
            CornerRadius="4">
            <StackPanel>
                <TextBlock
                    FontSize="20"
                    FontWeight="Bold"
                    Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                    Text="Session Manager" />
                <StackPanel Margin="0,4,0,0" Orientation="Horizontal">
                    <TextBlock
                        FontSize="12"
                        Foreground="{DynamicResource MahApps.Brushes.IdealForeground}"
                        Opacity="0.9"
                        Text="{Binding Sessions.Count, StringFormat='{}{0} Active Sessions'}" />
                </StackPanel>
            </StackPanel>
        </Border>

        <!--  Session Cards  -->
        <ScrollViewer
            Grid.Row="1"
            Margin="0,0,0,15"
            VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding Sessions}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border
                            Margin="0,0,0,12"
                            Padding="15"
                            Background="{DynamicResource MahApps.Brushes.ThemeBackground}"
                            BorderBrush="{DynamicResource MahApps.Brushes.Gray5}"
                            BorderThickness="1"
                            CornerRadius="6"
                            Cursor="Hand">
                            <Border.InputBindings>
                                <MouseBinding
                                    Command="{Binding DataContext.SetActiveCommand, RelativeSource={RelativeSource AncestorType=Controls:MetroWindow}}"
                                    CommandParameter="{Binding}"
                                    MouseAction="LeftClick" />
                            </Border.InputBindings>

                            <Border.Style>
                                <Style TargetType="Border">
                                    <Style.Triggers>
                                        <Trigger Property="IsMouseOver" Value="True">
                                            <Setter Property="BorderBrush" Value="{DynamicResource MahApps.Brushes.Accent}" />
                                            <Setter Property="BorderThickness" Value="2" />
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>

                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <!--  Status Indicator  -->
                                <Border
                                    Grid.Column="0"
                                    Width="60"
                                    Height="60"
                                    Margin="0,0,15,0"
                                    VerticalAlignment="Center"
                                    Background="{Binding State, Converter={StaticResource SessionStateToColorConverter}}"
                                    BorderBrush="{Binding InjectionState, Converter={StaticResource InjectionStateToColorConverter}}"
                                    BorderThickness="3"
                                    CornerRadius="30"
                                    ToolTip="{Binding StatusSummary}">
                                    <iconPacks:PackIconMaterial
                                        Width="30"
                                        Height="30"
                                        HorizontalAlignment="Center"
                                        VerticalAlignment="Center"
                                        Foreground="White"
                                        Kind="Monitor" />
                                </Border>

                                <!--  Session Info  -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <!--  Session Name (Editable)  -->
                                    <TextBox
                                        Margin="0,0,0,4"
                                        Padding="0"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        FontSize="16"
                                        FontWeight="SemiBold"
                                        Text="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                                    <!--  Session Details  -->
                                    <StackPanel Margin="0,0,0,4" Orientation="Horizontal">
                                        <Border
                                            Margin="0,0,8,0"
                                            Padding="6,2"
                                            Background="{Binding State, Converter={StaticResource SessionStateToColorConverter}}"
                                            CornerRadius="3">
                                            <TextBlock
                                                FontSize="11"
                                                FontWeight="SemiBold"
                                                Foreground="White"
                                                Text="{Binding State}" />
                                        </Border>

                                        <Border
                                            Margin="0,0,8,0"
                                            Padding="6,2"
                                            Background="{Binding InjectionState, Converter={StaticResource InjectionStateToColorConverter}}"
                                            CornerRadius="3">
                                            <TextBlock
                                                FontSize="11"
                                                FontWeight="SemiBold"
                                                Foreground="White"
                                                Text="{Binding InjectionState}" />
                                        </Border>

                                        <TextBlock
                                            VerticalAlignment="Center"
                                            FontSize="11"
                                            Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                                            Text="{Binding CreatedAt, StringFormat='Created: {0:HH:mm:ss}'}" />
                                    </StackPanel>

                                    <!--  Error Display  -->
                                    <Border
                                        Padding="8,4"
                                        Background="#FFFFE0"
                                        BorderBrush="#FFD700"
                                        BorderThickness="1"
                                        CornerRadius="3"
                                        Visibility="{Binding LastError, Converter={StaticResource NullToVisibilityConverter}}">
                                        <StackPanel Orientation="Horizontal">
                                            <iconPacks:PackIconMaterial
                                                Width="14"
                                                Height="14"
                                                Margin="0,0,6,0"
                                                VerticalAlignment="Center"
                                                Foreground="#FF8C00"
                                                Kind="AlertCircle" />
                                            <TextBlock
                                                MaxWidth="500"
                                                FontSize="11"
                                                Foreground="#8B4513"
                                                Text="{Binding LastError}"
                                                TextWrapping="Wrap" />
                                        </StackPanel>
                                    </Border>
                                </StackPanel>

                                <!--  Quick Actions  -->
                                <StackPanel
                                    Grid.Column="2"
                                    VerticalAlignment="Center"
                                    Orientation="Horizontal">
                                    <Button
                                        Width="36"
                                        Height="36"
                                        Margin="0,0,6,0"
                                        Command="{Binding DataContext.FocusCommand, RelativeSource={RelativeSource AncestorType=Controls:MetroWindow}}"
                                        CommandParameter="{Binding}"
                                        Style="{StaticResource MahApps.Styles.Button.Circle}"
                                        ToolTip="Focus Client Window">
                                        <iconPacks:PackIconMaterial
                                            Width="18"
                                            Height="18"
                                            Kind="Fullscreen" />
                                    </Button>

                                    <Button
                                        Width="36"
                                        Height="36"
                                        Command="{Binding DataContext.CloseCommand, RelativeSource={RelativeSource AncestorType=Controls:MetroWindow}}"
                                        CommandParameter="{Binding}"
                                        Style="{StaticResource MahApps.Styles.Button.Circle}"
                                        ToolTip="Close Session">
                                        <iconPacks:PackIconMaterial
                                            Width="18"
                                            Height="18"
                                            Foreground="#F44336"
                                            Kind="Close" />
                                    </Button>
                                </StackPanel>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!--  Bottom Actions  -->
        <Border
            Grid.Row="2"
            Padding="12"
            Background="{DynamicResource MahApps.Brushes.Gray9}"
            CornerRadius="4">
            <Grid>
                <TextBlock
                    HorizontalAlignment="Left"
                    VerticalAlignment="Center"
                    FontSize="11"
                    Foreground="{DynamicResource MahApps.Brushes.Gray2}"
                    Text="Click a session card to activate â€¢ Use buttons for quick actions" />

                <Button
                    Width="100"
                    Height="32"
                    HorizontalAlignment="Right"
                    Click="CloseButton_Click"
                    Content="Close" />
            </Grid>
        </Border>
    </Grid>
</Controls:MetroWindow>
